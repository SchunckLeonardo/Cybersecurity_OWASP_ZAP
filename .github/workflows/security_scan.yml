name: Security Scan with OWASP ZAP

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Dar permiss√£o de execu√ß√£o ao gradlew
        run: chmod +x gradlew

      - name: Build aplica√ß√£o Spring Boot
        run: ./gradlew build -x test

      - name: Iniciar aplica√ß√£o em background
        run: |
          ./gradlew bootRun &
          echo $! > app.pid
          echo "Aguardando aplica√ß√£o iniciar..."
          sleep 30 # Aguarda um tempo para a aplica√ß√£o subir completamente

      - name: Verificar se aplica√ß√£o est√° rodando
        run: |
          curl -f http://localhost:8080/actuator/health || exit 1
          echo "Aplica√ß√£o est√° respondendo!"

      - name: Executar OWASP ZAP Full Scan
        # Usamos continue-on-error para que a an√°lise dos resultados seja sempre executada
        continue-on-error: true
        run: |
          docker run \
            -v $(pwd):/zap/wrk/:rw \
            --network="host" \
            --user $(id -u):$(id -g) \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
              -t http://127.0.0.1:8080 \
              -p 8090 \
              -r zap-report.html \
              -x zap-report.xml

      - name: Analisar resultados do ZAP
        id: analyze_zap
        run: |
          if [ -f zap-report.xml ]; then
            echo "Relat√≥rio gerado com sucesso"
          
            # √â mais confi√°vel extrair de um XML
            HIGH_ALERTS=$(grep -o '<riskcode>3</riskcode>' zap-report.xml | wc -l)
            MEDIUM_ALERTS=$(grep -o '<riskcode>2</riskcode>' zap-report.xml | wc -l)
            LOW_ALERTS=$(grep -o '<riskcode>1</riskcode>' zap-report.xml | wc -l)
            INFO_ALERTS=$(grep -o '<riskcode>0</riskcode>' zap-report.xml | wc -l)
          
            # N√£o existe risco "Cr√≠tico" (4) no ZAP por padr√£o, o mais alto √© 3 (High)
            TOTAL_ALERTS=$((HIGH_ALERTS + MEDIUM_ALERTS + LOW_ALERTS + INFO_ALERTS))
          
            echo "=== RESUMO DA AN√ÅLISE DE SEGURAN√áA ==="
            echo "Total de alertas: $TOTAL_ALERTS"
            echo "Altos: $HIGH_ALERTS"
            echo "M√©dios: $MEDIUM_ALERTS"
            echo "Baixos: $LOW_ALERTS"
            echo "Informativos: $INFO_ALERTS"
            echo "======================================"
          
            echo "high_alerts=$HIGH_ALERTS" >> $GITHUB_OUTPUT
            echo "total_alerts=$TOTAL_ALERTS" >> $GITHUB_OUTPUT
          
            if [ "$HIGH_ALERTS" -gt 0 ]; then
              echo "‚ùå FALHA: Vulnerabilidades de n√≠vel alto detectadas!"
              exit 1
            fi
          else
            echo "Erro: Relat√≥rio XML n√£o foi gerado"
            exit 1
          fi

      - name: Upload relat√≥rio ZAP como artefato
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: |
            zap-report.html
            zap-report.xml
          retention-days: 30
          if-no-files-found: ignore # Evita erro se os arquivos n√£o forem criados

      - name: Parar aplica√ß√£o
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
          fi

      - name: Comentar PR com resultados
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const highAlerts = '${{ steps.analyze_zap.outputs.high_alerts || 0 }}';
            const totalAlerts = '${{ steps.analyze_zap.outputs.total_alerts || 0 }}';
            
            const comment = `## üîí Relat√≥rio de Seguran√ßa - OWASP ZAP
            
            | Severidade | Quantidade |
            |------------|------------|
            | üü† Alto    | ${highAlerts} |
            | **Total** | **${totalAlerts}** |
            
            ${parseInt(highAlerts) > 0 ? '‚ùå **Pipeline falhou devido a vulnerabilidades altas**' : '‚úÖ Nenhuma vulnerabilidade de n√≠vel alto detectada'}
            
            üìä Baixe o relat√≥rio completo nos artefatos do workflow.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });