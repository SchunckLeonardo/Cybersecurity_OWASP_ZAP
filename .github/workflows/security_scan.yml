name: OWASP ZAP Security Scan

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: Scan de SeguranÃ§a com OWASP ZAP

    steps:
      - name: 1. Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: 2. Setup do Java (JDK)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: 3. Build da aplicaÃ§Ã£o
        run: |
          chmod +x gradlew
          ./gradlew build -x test

      - name: 4. Inicia a aplicaÃ§Ã£o em background
        run: |
          nohup java -jar build/libs/*.jar > app.log 2>&1 &
          echo $! > app.pid
          echo "PID da aplicaÃ§Ã£o: $(cat app.pid)"

      - name: 5. Aguarda aplicaÃ§Ã£o inicializar
        run: |
          echo "Aguardando a aplicaÃ§Ã£o iniciar..."
          max_attempts=60
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -sf http://localhost:8080/actuator/health >/dev/null 2>&1 || \
               curl -sf http://localhost:8080 >/dev/null 2>&1; then
              echo "âœ“ AplicaÃ§Ã£o estÃ¡ no ar!"
              break
            fi
          
            attempt=$((attempt + 1))
            echo "Tentativa $attempt/$max_attempts..."
            sleep 2
          
            if [ $attempt -eq $max_attempts ]; then
              echo "âœ— Erro: AplicaÃ§Ã£o nÃ£o inicializou no tempo esperado"
              echo "Logs da aplicaÃ§Ã£o:"
              cat app.log
              exit 1
            fi
          done

      - name: 6. VerificaÃ§Ã£o da API Docs
        run: |
          echo "Verificando documentaÃ§Ã£o da API..."
          if curl -sf http://localhost:8080/v3/api-docs >/dev/null; then
            echo "âœ“ DocumentaÃ§Ã£o da API estÃ¡ acessÃ­vel!"
            curl -s http://localhost:8080/v3/api-docs | jq . || true
          else
            echo "âœ— Aviso: DocumentaÃ§Ã£o nÃ£o encontrada em /v3/api-docs"
            echo "Tentando outros endpoints comuns..."
            curl -s http://localhost:8080/swagger-ui.html || true
            curl -s http://localhost:8080/api-docs || true
          fi

      - name: 7. OWASP ZAP API Scan
        uses: zaproxy/action-api-scan@v0.5.0
        with:
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          target: 'http://host.docker.internal:8080/v3/api-docs'
          format: 'openapi'
          fail_action: false
          cmd_options: '-a -r zap_report.html -J zap_report.json -w zap_report.md'
        continue-on-error: true

      - name: 8. Verificar se relatÃ³rios foram gerados
        if: always()
        run: |
          echo "Verificando arquivos gerados:"
          ls -lah zap_report.* 2>/dev/null || echo "Nenhum relatÃ³rio encontrado"
          
          if [ -f "zap_report.json" ]; then
            echo "ConteÃºdo do JSON (primeiras linhas):"
            head -n 50 zap_report.json
          fi

      - name: 9. Upload do RelatÃ³rio ZAP
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-zap-seguranca
          path: |
            zap_report.*
            app.log
          if-no-files-found: warn

      - name: 10. AnÃ¡lise de Vulnerabilidades
        if: always()
        run: |
          if [ ! -f "zap_report.json" ]; then
            echo "âš ï¸ RelatÃ³rio JSON nÃ£o foi gerado. Pulando anÃ¡lise."
            exit 0
          fi
          
          # Instala jq se necessÃ¡rio
          command -v jq >/dev/null 2>&1 || sudo apt-get update && sudo apt-get install -y jq
          
          # Verifica estrutura do JSON
          echo "Estrutura do relatÃ³rio:"
          jq 'keys' zap_report.json
          
          # Conta alertas por severidade
          high_alerts=$(jq '[.site[]?.alerts[]? | select(.riskcode == "3" or .risk == "High")] | length' zap_report.json 2>/dev/null || echo "0")
          medium_alerts=$(jq '[.site[]?.alerts[]? | select(.riskcode == "2" or .risk == "Medium")] | length' zap_report.json 2>/dev/null || echo "0")
          low_alerts=$(jq '[.site[]?.alerts[]? | select(.riskcode == "1" or .risk == "Low")] | length' zap_report.json 2>/dev/null || echo "0")
          info_alerts=$(jq '[.site[]?.alerts[]? | select(.riskcode == "0" or .risk == "Informational")] | length' zap_report.json 2>/dev/null || echo "0")
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š RESUMO DAS VULNERABILIDADES"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”´ Risco Alto:    $high_alerts"
          echo "ðŸŸ  Risco MÃ©dio:   $medium_alerts"
          echo "ðŸŸ¡ Risco Baixo:   $low_alerts"
          echo "â„¹ï¸  Informacional: $info_alerts"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Lista vulnerabilidades de alto risco
          if [ "$high_alerts" -gt 0 ]; then
            echo ""
            echo "ðŸ”´ VULNERABILIDADES DE ALTO RISCO:"
            jq -r '.site[]?.alerts[]? | select(.riskcode == "3" or .risk == "High") | "  - \(.name) (\(.count) ocorrÃªncias)"' zap_report.json 2>/dev/null || true
          fi
          
          # Lista vulnerabilidades de mÃ©dio risco
          if [ "$medium_alerts" -gt 0 ]; then
            echo ""
            echo "ðŸŸ  VULNERABILIDADES DE MÃ‰DIO RISCO:"
            jq -r '.site[]?.alerts[]? | select(.riskcode == "2" or .risk == "Medium") | "  - \(.name) (\(.count) ocorrÃªncias)"' zap_report.json 2>/dev/null || true
          fi
          
          # Define critÃ©rio de falha
          total_critical=$((high_alerts + medium_alerts))
          
          if [ "$total_critical" -gt 0 ]; then
            echo ""
            echo "âŒ Build FALHOU: $total_critical vulnerabilidade(s) crÃ­tica(s) encontrada(s)!"
            exit 1
          else
            echo ""
            echo "âœ… Build APROVADO: Nenhuma vulnerabilidade crÃ­tica encontrada!"
          fi

      - name: 11. Finalizar aplicaÃ§Ã£o
        if: always()
        run: |
          if [ -f app.pid ]; then
            echo "Finalizando aplicaÃ§Ã£o..."
            kill $(cat app.pid) 2>/dev/null || true
          fi